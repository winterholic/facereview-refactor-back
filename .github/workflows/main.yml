name: CI/CD - Build, Test & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  APP_NAME: facereview
  DEPLOY_PATH: /home/ubuntu/facereview
  DOCKER_IMAGE: facereview-app

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov flake8
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Flake8
      run: |
        flake8 app/ common/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ common/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

    - name: Run tests
      run: |
        if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
          pytest tests/ -v --cov=app --cov-report=term
        else
          echo "No tests found. Skipping test execution."
        fi
      continue-on-error: true

  build:
    name: Build Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cat > .env << EOF
        FLASK_APP=${{ secrets.FLASK_APP }}
        FLASK_ENV=${{ secrets.FLASK_ENV }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}

        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}

        MONGO_HOST=${{ secrets.MONGO_HOST }}
        MONGO_PORT=${{ secrets.MONGO_PORT }}
        MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }}

        JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}

        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_DB=${{ secrets.REDIS_DB }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

        YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}

        SMTP_SERVER=${{ secrets.SMTP_SERVER }}
        SMTP_PORT=${{ secrets.SMTP_PORT }}
        SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
        SMTP_FROM_EMAIL=${{ secrets.SMTP_FROM_EMAIL }}

        KAFKA_BOOTSTRAP_SERVERS=${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
        KAFKA_CLIENT_ID=${{ secrets.KAFKA_CLIENT_ID }}
        KAFKA_GROUP_ID=${{ secrets.KAFKA_GROUP_ID }}
        KAFKA_TOPIC_USER_EVENT=${{ secrets.KAFKA_TOPIC_USER_EVENT }}
        EOF

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "."
        target: ${{ env.DEPLOY_PATH }}/temp-deploy
        rm: true

    - name: Build Docker image on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸ”¨ Building Docker image..."
          cd ${{ env.DEPLOY_PATH }}/temp-deploy

          # .env íŒŒì¼ì„ ë©”ì¸ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
          cp .env ${{ env.DEPLOY_PATH }}/.env

          # ì†ŒìŠ¤ ì½”ë“œ ì—…ë°ì´íŠ¸
          rsync -av --exclude='.git' --exclude='temp-deploy' --exclude='venv' --exclude='__pycache__' ./ ${{ env.DEPLOY_PATH }}/

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          cd ${{ env.DEPLOY_PATH }}
          docker build -t ${{ env.DOCKER_IMAGE }}:latest .

          # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
          rm -rf ${{ env.DEPLOY_PATH }}/temp-deploy

          echo "âœ… Docker image built successfully"

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy Docker container
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸš€ Starting zero-downtime deployment..."

          cd ${{ env.DEPLOY_PATH }}

          # ë°±ì—… ìƒì„±
          echo "ğŸ’¾ Creating backup..."
          BACKUP_DIR="../facereview-backup-$(date +%Y%m%d-%H%M%S)"
          mkdir -p $BACKUP_DIR
          docker save ${{ env.DOCKER_IMAGE }}:latest -o $BACKUP_DIR/image.tar 2>/dev/null || echo "No previous image to backup"

          # ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh

          echo "âœ… Deployment completed successfully!"

    - name: Send deployment notification
      if: always()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful - $(date)"
          else
            echo "âŒ Deployment failed - $(date)"
            # ë°±ì—…ì—ì„œ ë³µêµ¬
            LATEST_BACKUP=$(ls -dt ../facereview-backup-* 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ] && [ -f "$LATEST_BACKUP/image.tar" ]; then
              echo "Rolling back to: $LATEST_BACKUP"
              docker load -i $LATEST_BACKUP/image.tar
              cd ${{ env.DEPLOY_PATH }}
              ./scripts/deploy.sh
            fi
          fi
      continue-on-error: true

  cleanup:
    name: Cleanup old backups
    needs: deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Remove old backups and images
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # ìµœê·¼ 5ê°œì˜ ë°±ì—…ë§Œ ìœ ì§€
          cd /home/ubuntu
          ls -dt facereview-backup-* 2>/dev/null | tail -n +6 | xargs rm -rf

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f

          echo "ğŸ§¹ Cleanup completed"
      continue-on-error: true
