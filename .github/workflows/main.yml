name: CI/CD - Build, Test & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  APP_NAME: facereview
  DEPLOY_PATH: /home/winterholic/projects/services/new-facereview

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov flake8
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Flake8
      run: |
        flake8 app/ common/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app/ common/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

    - name: Run tests
      run: |
        if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
          pytest tests/ -v --cov=app --cov-report=term
        else
          echo "No tests found. Skipping test execution."
        fi
      continue-on-error: true

  deploy:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cat > .env << EOF
        FLASK_APP=${{ secrets.FLASK_APP }}
        FLASK_ENV=${{ secrets.FLASK_ENV }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}

        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}

        MONGO_HOST=${{ secrets.MONGO_HOST }}
        MONGO_PORT=${{ secrets.MONGO_PORT }}
        MONGO_DB_NAME=${{ secrets.MONGO_DB_NAME }}

        JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}

        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_DB=${{ secrets.REDIS_DB }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

        YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}

        SMTP_SERVER=${{ secrets.SMTP_SERVER }}
        SMTP_PORT=${{ secrets.SMTP_PORT }}
        SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
        SMTP_FROM_EMAIL=${{ secrets.SMTP_FROM_EMAIL }}

        KAFKA_BOOTSTRAP_SERVERS=${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
        KAFKA_CLIENT_ID=${{ secrets.KAFKA_CLIENT_ID }}
        KAFKA_GROUP_ID=${{ secrets.KAFKA_GROUP_ID }}
        KAFKA_TOPIC_USER_EVENT=${{ secrets.KAFKA_TOPIC_USER_EVENT }}

        LOG_LEVEL=INFO
        EOF

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "."
        target: ${{ env.DEPLOY_PATH }}
        rm: false
        overwrite: true

    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ðŸš€ Starting deployment..."

          cd ${{ env.DEPLOY_PATH }}

          mkdir -p logs uploads

          chmod +x scripts/deploy.sh

          ./scripts/deploy.sh

          echo "âœ… Deployment completed!"

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd ${{ env.DEPLOY_PATH }}

          echo "ðŸ“Š Checking service status..."
          docker compose ps

          echo ""
          echo "ðŸ” Checking app health..."
          sleep 10
          curl -f http://localhost:5000/health || echo "âš ï¸ Health check failed"

          echo ""
          echo "ðŸ“ Recent logs:"
          docker compose logs --tail=20 app

    - name: Cleanup old resources
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ðŸ§¹ Cleaning up old Docker resources..."
          docker image prune -f
          echo "âœ… Cleanup completed"
      continue-on-error: true
